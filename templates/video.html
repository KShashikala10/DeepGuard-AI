{% extends 'base.html' %}

{% block title %}Video Detection - DeepGuard AI{% endblock %}

{% block content %}
<div class="page-background" style="background: linear-gradient(135deg, var(--primary-black) 0%, var(--primary-dark) 30%, var(--primary-gray) 60%, var(--lemon-dark) 100%); 
     min-height: 100vh; 
     padding: 2rem 0;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
          <ol class="breadcrumb" style="background: rgba(255, 215, 0, 0.1); border-radius: 10px; padding: 1rem;">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}" style="color: var(--lemon-primary); text-decoration: none; font-weight: 600;">Home</a></li>
            <li class="breadcrumb-item active" style="color: var(--lemon-bright); font-weight: 600;">Video Detection</li>
          </ol>
        </nav>

        <!-- Page Header -->
        <div class="text-center mb-5" style="background: rgba(0, 0, 0, 0.7); padding: 2rem; border-radius: 15px; border: 2px solid var(--lemon-primary);">
          <div class="mb-3">
            <i class="bi bi-camera-video display-4" style="color: var(--lemon-primary); filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8));"></i>
          </div>
          <h1 class="h2 fw-bold mb-3" style="color: var(--lemon-bright); text-shadow: 2px 2px 4px rgba(0,0,0,0.8); font-size: 2.5rem;">Video Deepfake Detection</h1>
          <p class="lead" style="color: var(--lemon-light); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); font-weight: 500; font-size: 1.3rem;">Upload a video to analyze for deepfake content across multiple frames</p>
        </div>

        <!-- Upload Section -->
        <div class="mb-5">
          <form method="post" enctype="multipart/form-data" id="uploadForm">
            <div class="card shadow-lg" style="background: rgba(0, 0, 0, 0.8); border: 2px solid var(--lemon-primary); border-radius: 15px;">
              <div class="card-body p-5 text-center upload-area" id="uploadArea" style="cursor: pointer; border-radius: 15px;">
                <div class="">
                  <div class="mb-3">
                    <i class="bi bi-camera-video display-4" style="color: var(--lemon-primary); filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6));"></i>
                  </div>
                  <h4 class="h5 mb-2" style="color: var(--lemon-bright); text-shadow: 1px 1px 3px rgba(0,0,0,0.8); font-size: 1.5rem;">Drop your video here</h4>
                  <p class="mb-3" style="color: var(--lemon-light); text-shadow: 1px 1px 2px rgba(0,0,0,0.7); font-size: 1.1rem; font-weight: 500;">or click to browse files</p>
                  <div class="d-flex justify-content-center gap-2 flex-wrap">
                    <span class="badge" style="background: var(--lemon-primary); color: var(--primary-black); font-weight: 600; padding: 0.5rem 1rem; font-size: 0.9rem;">MP4</span>
                    <span class="badge" style="background: var(--lemon-primary); color: var(--primary-black); font-weight: 600; padding: 0.5rem 1rem; font-size: 0.9rem;">AVI</span>
                    <span class="badge" style="background: var(--lemon-primary); color: var(--primary-black); font-weight: 600; padding: 0.5rem 1rem; font-size: 0.9rem;">MOV</span>
                    <span class="badge" style="background: var(--lemon-primary); color: var(--primary-black); font-weight: 600; padding: 0.5rem 1rem; font-size: 0.9rem;">MKV</span>
                  </div>
                </div>
                <input type="file" name="video" id="videoInput" accept="video/*" required hidden>
              </div>
              
              <!-- Video Preview -->
              <div class="card-body border-top" id="videoPreview" style="display: none; background: rgba(0, 0, 0, 0.9); border-top: 1px solid var(--lemon-primary) !important; border-radius: 0 0 15px 15px;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                  <h5 class="mb-0" style="color: var(--lemon-bright); text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">Selected Video</h5>
                  <button type="button" class="btn btn-outline-primary btn-sm" id="changeVideo" style="border-color: var(--lemon-primary); color: var(--lemon-primary); background: rgba(255, 215, 0, 0.1);">
                    <i class="bi bi-arrow-repeat me-1"></i>Change
                  </button>
                </div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <video id="previewVideo" controls class="w-100 rounded" style="border: 2px solid var(--lemon-primary);">
                    Your browser does not support the video tag.
                  </video>
                </div>
                <div class="col-md-6">
                  <div class="d-flex flex-column gap-2">
                    <div class="d-flex justify-content-between">
                      <span class="fw-medium">File:</span>
                      <span class="text-muted" id="fileName"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span class="fw-medium">Size:</span>
                      <span class="text-muted" id="fileSize"></span>
                    </div>
                    <div class="d-flex justify-content-between">
                      <span class="fw-medium">Type:</span>
                      <span class="text-muted" id="fileType"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card-footer text-center">
              <button type="submit" class="btn btn-lg btn-primary" id="analyzeBtn" disabled>
                <i class="bi bi-search me-2"></i>Analyze Video
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Error Display -->
      {% if error %}
      <div class="alert alert-danger d-flex align-items-center" role="alert">
        <div class="me-3">
          <i class="bi bi-exclamation-triangle"></i>
        </div>
        <div>
          <strong>Error:</strong> {{ error }}
        </div>
      </div>
      {% endif %}

      <!-- Results Section -->
      {% if result %}
      <div class="mb-5" id="videoResultsSection" 
           data-result="{{ result }}" 
           data-confidence="{{ confidence }}" 
           data-fake-votes="{{ fake_votes }}" 
           data-real-votes="{{ real_votes }}">
        <div class="card shadow">
          <div class="card-header">
            <h3 class="card-title mb-0">
              <i class="bi bi-clipboard-data me-2"></i>Analysis Results
            </h3>
          </div>
          
          <div class="card-body">
            <div class="row g-4">
              <!-- Results Overview -->
              <div class="col-md-6">
                <div class="">
                  <!-- Classification Result -->
                  <div class="mb-4">
                    <div class="badge {% if result=='Fake' %}result-fake{% else %}result-authentic{% endif %} fs-6 p-3">
                      {% if result=='Fake' %}
                        <i class="bi bi-exclamation-triangle me-2"></i>{{ result }}
                      {% else %}
                        <i class="bi bi-check-circle me-2"></i>{{ result }}
                      {% endif %}
                    </div>
                  </div>

                  <!-- Confidence Score -->
                  <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span class="fw-medium">Overall Confidence</span>
                      <span class="fw-bold">{{ confidence }}</span>
                    </div>
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar {% if result=='Fake' %}bg-danger{% else %}bg-success{% endif %}"
                           role="progressbar" data-width="{{ confidence }}"></div>
                    </div>
                  </div>

                  <!-- Detection Statistics -->
                  <div class="mb-4">
                    <h6 class="fw-bold mb-3">Frame Analysis</h6>
                    <div class="row g-3 mb-3">
                      <div class="col-6">
                        <div class="card border-danger">
                          <div class="card-body text-center">
                            <div class="h4 text-danger mb-0">{{ fake_votes }}</div>
                            <div class="small text-muted">Fake Detections</div>
                          </div>
                        </div>
                      </div>
                      <div class="col-6">
                        <div class="card border-success">
                          <div class="card-body text-center">
                            <div class="h4 text-success mb-0">{{ real_votes }}</div>
                            <div class="small text-muted">Real Detections</div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Visual Progress Bar -->
                    <div class="mb-3">
                      {% set total_votes = fake_votes + real_votes %}
                      {% if total_votes > 0 %}
                        {% set fake_percentage = (fake_votes / total_votes * 100) %}
                        {% set real_percentage = (real_votes / total_votes * 100) %}
                        <div class="progress" style="height: 30px;">
                          <div class="progress-bar bg-danger" data-width="{{ fake_percentage }}%">
                            <span class="text-white fw-medium">{{ fake_votes }}</span>
                          </div>
                          <div class="progress-bar bg-success" data-width="{{ real_percentage }}%">
                            <span class="text-white fw-medium">{{ real_votes }}</span>
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Additional Info -->
                  <div class="mb-4">
                    <div class="card bg-light">
                      <div class="card-body">
                        <h6 class="card-title">Processing Details</h6>
                        <div class="row g-2">
                          <div class="col-12">
                            <div class="d-flex justify-content-between">
                              <span class="fw-medium">Total Frames:</span>
                              <span class="text-muted">{{ fake_votes + real_votes }}</span>
                            </div>
                          </div>
                          <div class="col-12">
                            <div class="d-flex justify-content-between">
                              <span class="fw-medium">Model:</span>
                              <span class="text-muted">DeepGuard Video AI</span>
                            </div>
                          </div>
                          <div class="col-12">
                            <div class="d-flex justify-content-between">
                              <span class="fw-medium">Accuracy:</span>
                              <span class="text-muted">97.8%</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Action Buttons -->
                  <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-info" onclick="downloadVideoReport()">
                      <i class="bi bi-file-earmark-pdf me-2"></i>Download Report
                    </button>
                    <a href="{{ url_for('video_detector') }}" class="btn btn-secondary">
                      <i class="bi bi-arrow-repeat me-2"></i>Analyze Another Video
                    </a>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                      <i class="bi bi-house me-2"></i>Back to Home
                    </a>
                  </div>
                </div>
              </div>

              <!-- Detected Faces -->
              {% if saved_faces %}
              <div class="col-md-6">
                <div class="">
                  <h6 class="fw-bold mb-3">
                    <i class="bi bi-person-bounding-box me-2"></i>Detected Faces ({{ saved_faces|length }} frames)
                  </h6>
                  <div class="row g-2 mb-3">
                    {% for face_img in saved_faces %}
                      <div class="col-4 col-sm-3">
                        <div class="position-relative">
                          <img src="{{ url_for('static', filename=face_img) }}" 
                               alt="Detected face" 
                               class="img-fluid rounded shadow-sm cursor-pointer face-image">
                          <div class="position-absolute top-50 start-50 translate-middle text-white opacity-0 hover-opacity-100 transition">
                            <i class="bi bi-eye"></i>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                  <div class="">
                    <small class="text-muted">
                      <i class="bi bi-info-circle me-1"></i>
                      Showing sample frames with detected faces from video analysis
                    </small>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const uploadArea = document.getElementById('uploadArea');
  const videoInput = document.getElementById('videoInput');
  const videoPreview = document.getElementById('videoPreview');
  const previewVideo = document.getElementById('previewVideo');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const changeVideoBtn = document.getElementById('changeVideo');
  const uploadForm = document.getElementById('uploadForm');

  // Save report data if results are present
  const videoResultsSection = document.getElementById('videoResultsSection');
  if (videoResultsSection) {
    const reportData = {
      type: 'video',
      fileName: 'video_analysis.mp4',
      result: videoResultsSection.dataset.result,
      confidence: videoResultsSection.dataset.confidence,
      fakeVotes: parseInt(videoResultsSection.dataset.fakeVotes) || 0,
      realVotes: parseInt(videoResultsSection.dataset.realVotes) || 0
    };
    
    // Save to localStorage
    saveReportToStorage(reportData);
  }

  // File input change handler
  videoInput.addEventListener('change', handleFileSelect);
  changeVideoBtn.addEventListener('click', function() {
    videoInput.click();
  });

  // Drag and drop handlers
  uploadArea.addEventListener('click', function() {
    videoInput.click();
  });

  uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      videoInput.files = files;
      handleFileSelect();
    }
  });

  function handleFileSelect() {
    const file = videoInput.files[0];
    if (file) {
      // Validate file type
      const validTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/quicktime', 'video/x-msvideo', 'video/x-matroska'];
      if (!validTypes.includes(file.type)) {
        alert('Please select a valid video file (MP4, AVI, MOV, MKV)');
        return;
      }

      // Show preview
      const url = URL.createObjectURL(file);
      previewVideo.src = url;
      uploadArea.style.display = 'none';
      videoPreview.style.display = 'block';
      analyzeBtn.disabled = false;

      // Update file details
      document.getElementById('fileName').textContent = file.name;
      document.getElementById('fileSize').textContent = formatFileSize(file.size);
      document.getElementById('fileType').textContent = file.type;
    }
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // Form submission handler
  uploadForm.addEventListener('submit', function(e) {
    const submitBtn = analyzeBtn;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Analyzing Video...';
    submitBtn.disabled = true;
    submitBtn.classList.add('btn-secondary');
    submitBtn.classList.remove('btn-primary');
    
    // Show enhanced processing message
    const processingMsg = document.createElement('div');
    processingMsg.className = 'processing-message mt-3';
    processingMsg.innerHTML = `
      <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-primary me-3" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div>
          <div class="fw-bold text-primary mb-1">
            <i class="bi bi-cpu me-2"></i>AI Analysis in Progress
          </div>
          <div class="text-muted">
            Processing video frames with advanced neural networks... This may take several minutes depending on video length and complexity.
          </div>
          <div class="mt-2">
            <small class="text-info">
              <i class="bi bi-info-circle me-1"></i>
              Our AI is examining each frame for deepfake patterns and temporal inconsistencies
            </small>
          </div>
        </div>
      </div>
    `;
    uploadForm.appendChild(processingMsg);
    
    // Add progress indicator
    setTimeout(() => {
      const progressContainer = document.createElement('div');
      progressContainer.className = 'mt-3';
      progressContainer.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <small class="text-muted">Processing Status</small>
          <small class="text-primary fw-medium">Analyzing frames...</small>
        </div>
        <div class="progress" style="height: 8px;">
          <div class="progress-bar bg-primary progress-bar-striped progress-bar-animated" 
               role="progressbar" style="width: 0%" id="analysisProgress"></div>
        </div>
      `;
      processingMsg.appendChild(progressContainer);
      
      // Simulate progress (since we can't get real progress from backend)
      let progress = 0;
      const progressBar = document.getElementById('analysisProgress');
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90; // Cap at 90% until real completion
        progressBar.style.width = progress + '%';
        
        if (progress > 30) {
          progressContainer.querySelector('.text-primary').textContent = 'Detecting faces...';
        }
        if (progress > 60) {
          progressContainer.querySelector('.text-primary').textContent = 'Running deepfake detection...';
        }
        if (progress > 85) {
          progressContainer.querySelector('.text-primary').textContent = 'Finalizing results...';
        }
      }, 1000);
      
      // Clear interval when form would naturally submit
      setTimeout(() => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressContainer.querySelector('.text-primary').textContent = 'Analysis complete!';
      }, 10000);
      
    }, 1000);
  });

  // Face image click handlers
  document.querySelectorAll('.face-image').forEach(img => {
    img.addEventListener('click', function() {
      // Create modal or enlarged view
      const modal = document.createElement('div');
      modal.className = 'face-modal';
      modal.innerHTML = `
        <div class="face-modal-content">
          <span class="face-modal-close">&times;</span>
          <img src="${this.src}" alt="Enlarged face">
        </div>
      `;
      document.body.appendChild(modal);
      
      modal.querySelector('.face-modal-close').addEventListener('click', function() {
        document.body.removeChild(modal);
      });
    });
  });

  // Apply progress bar widths from data attributes
  document.querySelectorAll('.progress-bar[data-width]').forEach(progressBar => {
    const width = progressBar.getAttribute('data-width');
    progressBar.style.width = width;
  });
});

// Report functionality
function downloadVideoReport() {
  const videoResultsSection = document.getElementById('videoResultsSection');
  if (videoResultsSection) {
    const reportData = {
      type: 'video',
      fileName: 'video_analysis.mp4',
      result: videoResultsSection.dataset.result,
      confidence: videoResultsSection.dataset.confidence,
      fakeVotes: parseInt(videoResultsSection.dataset.fakeVotes) || 0,
      realVotes: parseInt(videoResultsSection.dataset.realVotes) || 0,
      timestamp: new Date().toISOString()
    };
    
    generateVideoPDF(reportData);
  }
}

function generateVideoPDF(report) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Define colors (RGB values) - Updated to match lemon/black theme
  const primaryLemon = [255, 215, 0];   // Lemon Yellow
  const primaryBlack = [0, 0, 0];       // Black
  const darkGray = [26, 26, 26];        // Dark Gray
  const lightGray = [45, 45, 45];       // Light Gray
  const success = [34, 197, 94];
  const danger = [239, 68, 68];
  
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  
  // Add watermark logo
  const logoImg = new Image();
  logoImg.onload = function() {
    // Add logo as watermark in center of page
    const logoWidth = 80;
    const logoHeight = 80;
    const logoX = (pageWidth - logoWidth) / 2;
    const logoY = (pageHeight - logoHeight) / 2;
    
    // Set opacity for watermark effect
    doc.saveGraphicsState();
    doc.setGState(new doc.GState({opacity: 0.15}));
    doc.addImage(logoImg, 'PNG', logoX, logoY, logoWidth, logoHeight);
    doc.restoreGraphicsState();
    
    // Generate PDF content after watermark is added
    generatePDFContent();
  };
  logoImg.src = "{{ url_for('static', filename='logo.png') }}";
  
  function generatePDFContent() {
    // Document border
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
    doc.rect(15, 15, pageWidth - 30, pageHeight - 30);
    
    // Header section with background
    doc.setFillColor(primaryLemon[0], primaryLemon[1], primaryLemon[2]);
    doc.rect(15, 15, pageWidth - 30, 35, 'F');
    
    // Header text
    doc.setFontSize(24);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(primaryBlack[0], primaryBlack[1], primaryBlack[2]);
    doc.text('DEEPGUARD AI', 25, 35);
    
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text('VIDEO DEEPFAKE DETECTION ANALYSIS REPORT', 25, 45);
  
  // Report metadata
  doc.setFontSize(10);
  const reportId = `VID-${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}-${String(new Date().getDate()).padStart(2, '0')}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
  doc.text(`Report ID: ${reportId}`, pageWidth - 80, 30);
  doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, pageWidth - 80, 40);
  
  let currentY = 70;
  
  // Executive Summary Section
  doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
  doc.rect(20, currentY, pageWidth - 40, 12, 'F');
  doc.setDrawColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
  doc.setLineWidth(2);
  doc.line(20, currentY, pageWidth - 20, currentY);
  
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
  doc.text('EXECUTIVE SUMMARY', 25, currentY + 8);
  
  currentY += 20;
  
  // Summary box
  doc.setDrawColor(200, 200, 200);
  doc.setLineWidth(0.5);
  doc.rect(25, currentY, pageWidth - 50, 25);
  
  doc.setFontSize(12);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
  doc.text('Analysis Result:', 30, currentY + 10);
  
  // Result with color coding
  const resultColor = (report.result === 'Fake' || report.result === 'Deepfake') ? danger : success;
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(resultColor[0], resultColor[1], resultColor[2]);
  doc.text(report.result.toUpperCase(), 80, currentY + 10);
  
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
  doc.text('Confidence:', 30, currentY + 18);
  doc.setFont('helvetica', 'bold');
  doc.text(report.confidence, 80, currentY + 18);
  
  currentY += 35;
  
  // File Information Section
  doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
  doc.rect(20, currentY, pageWidth - 40, 12, 'F');
  doc.setDrawColor(secondaryTeal[0], secondaryTeal[1], secondaryTeal[2]);
  doc.setLineWidth(2);
  doc.line(20, currentY, pageWidth - 20, currentY);
  
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(secondaryTeal[0], secondaryTeal[1], secondaryTeal[2]);
  doc.text('FILE INFORMATION', 25, currentY + 8);
  
  currentY += 20;
  
  // File info table
  const fileInfo = [
    ['File Name:', report.fileName],
    ['File Type:', 'VIDEO'],
    ['Analysis Date:', `${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`],
    ['Processing Method:', 'Frame-by-Frame Analysis'],
    ['Model Version:', 'DeepGuard Video AI v3.1']
  ];
  
  fileInfo.forEach((row, index) => {
    if (index % 2 === 0) {
      doc.setFillColor(250, 250, 250);
      doc.rect(25, currentY, pageWidth - 50, 8, 'F');
    }
    
    doc.setDrawColor(220, 220, 220);
    doc.setLineWidth(0.2);
    doc.rect(25, currentY, (pageWidth - 50) / 2, 8);
    doc.rect(25 + (pageWidth - 50) / 2, currentY, (pageWidth - 50) / 2, 8);
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
    doc.text(row[0], 30, currentY + 5.5);
    
    doc.setFont('helvetica', 'normal');
    doc.text(row[1], 30 + (pageWidth - 50) / 2, currentY + 5.5);
    
    currentY += 8;
  });
  
  currentY += 10;
  
  // Detection Results Section
  doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
  doc.rect(20, currentY, pageWidth - 40, 12, 'F');
  doc.setDrawColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
  doc.setLineWidth(2);
  doc.line(20, currentY, pageWidth - 20, currentY);
  
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
  doc.text('DETECTION RESULTS', 25, currentY + 8);
  
  currentY += 20;
  
  // Results table
  const detectionResults = [
    ['Overall Result:', report.result],
    ['Confidence Score:', report.confidence],
    ['Model Version:', 'DeepGuard Video AI v3.1'],
    ['Algorithm:', 'Advanced Neural Network'],
    ['Accuracy Rate:', '97.8%']
  ];
  
  detectionResults.forEach((row, index) => {
    // Highlight first row (main result)
    if (index === 0) {
      const bgColor = (report.result === 'Fake' || report.result === 'Deepfake') ? danger : success;
      doc.setFillColor(bgColor[0], bgColor[1], bgColor[2]);
      doc.rect(25, currentY, pageWidth - 50, 8, 'F');
    } else if (index % 2 === 0) {
      doc.setFillColor(250, 250, 250);
      doc.rect(25, currentY, pageWidth - 50, 8, 'F');
    }
    
    doc.setDrawColor(220, 220, 220);
    doc.setLineWidth(0.2);
    doc.rect(25, currentY, (pageWidth - 50) / 2, 8);
    doc.rect(25 + (pageWidth - 50) / 2, currentY, (pageWidth - 50) / 2, 8);
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    const textColor = (index === 0) ? [255, 255, 255] : darkGray;
    doc.setTextColor(textColor[0], textColor[1], textColor[2]);
    doc.text(row[0], 30, currentY + 5.5);
    
    doc.setFont('helvetica', 'normal');
    doc.text(row[1], 30 + (pageWidth - 50) / 2, currentY + 5.5);
    
    currentY += 8;
  });
  
  currentY += 15;
  
  // Frame Analysis Section
  doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
  doc.rect(20, currentY, pageWidth - 40, 12, 'F');
  doc.setDrawColor(secondaryTeal[0], secondaryTeal[1], secondaryTeal[2]);
  doc.setLineWidth(2);
  doc.line(20, currentY, pageWidth - 20, currentY);
  
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(secondaryTeal[0], secondaryTeal[1], secondaryTeal[2]);
  doc.text('VIDEO FRAME ANALYSIS', 25, currentY + 8);
  
  currentY += 20;
  
  const fakeVotes = report.fakeVotes || 0;
  const realVotes = report.realVotes || 0;
  const totalFrames = fakeVotes + realVotes;
  
  const videoAnalysis = [
    ['Total Frames Analyzed:', totalFrames.toString()],
    ['Fake Detections:', fakeVotes.toString()],
    ['Real Detections:', realVotes.toString()],
    ['Fake Percentage:', totalFrames > 0 ? `${((fakeVotes / totalFrames) * 100).toFixed(1)}%` : '0%'],
    ['Real Percentage:', totalFrames > 0 ? `${((realVotes / totalFrames) * 100).toFixed(1)}%` : '0%']
  ];
  
  videoAnalysis.forEach((row, index) => {
    if (index % 2 === 0) {
      doc.setFillColor(250, 250, 250);
      doc.rect(25, currentY, pageWidth - 50, 8, 'F');
    }
    
    doc.setDrawColor(220, 220, 220);
    doc.setLineWidth(0.2);
    doc.rect(25, currentY, (pageWidth - 50) / 2, 8);
    doc.rect(25 + (pageWidth - 50) / 2, currentY, (pageWidth - 50) / 2, 8);
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
    doc.text(row[0], 30, currentY + 5.5);
    
    doc.setFont('helvetica', 'normal');
    doc.text(row[1], 30 + (pageWidth - 50) / 2, currentY + 5.5);
    
    currentY += 8;
  });
  
  currentY += 15;
  
  // Technical Specifications Section
  doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
  doc.rect(20, currentY, pageWidth - 40, 12, 'F');
  doc.setDrawColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
  doc.setLineWidth(2);
  doc.line(20, currentY, pageWidth - 20, currentY);
  
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
  doc.text('TECHNICAL SPECIFICATIONS', 25, currentY + 8);
  
  currentY += 20;
  
  // Technical details box
  doc.setDrawColor(200, 200, 200);
  doc.setLineWidth(0.5);
  doc.rect(25, currentY, pageWidth - 50, 45);
  
  const features = [
    'Advanced Frame-by-Frame Neural Network Analysis',
    'Temporal Consistency Detection Algorithms',
    'Real-time Video Processing Capability',
    '97.8% Accuracy Rate on Video Validation Dataset',
    'Robust Against Various Video Deepfake Techniques',
    'ISO 27001 Compliant Security Standards'
  ];
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
  
  features.forEach((feature, index) => {
    doc.text(`• ${feature}`, 30, currentY + 10 + (index * 7));
  });
  
  // Footer
  const footerY = pageHeight - 25;
  doc.setDrawColor(200, 200, 200);
  doc.setLineWidth(0.5);
  doc.line(20, footerY - 5, pageWidth - 20, footerY - 5);
  
  doc.setFontSize(8);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
  doc.text('DeepGuard AI - Advanced Deepfake Detection Technology', 20, footerY);
  doc.text('© 2025 All rights reserved | Confidential Report', 20, footerY + 7);
  doc.text('Page 1 of 1', pageWidth - 40, footerY);
  doc.text('www.deepguard.ai', pageWidth - 40, footerY + 7);
  
  // Save the PDF
  const fileName = `DeepGuard_Video_Analysis_Report_${report.fileName.replace(/\.[^/.]+$/, "")}_${new Date().toISOString().split('T')[0]}.pdf`;
  doc.save(fileName);
  } // End of generatePDFContent function
  
  // Handle error if logo fails to load
  logoImg.onerror = function() {
    console.warn('Logo failed to load, generating PDF without watermark');
    generatePDFContent();
  };
}

function saveReportToStorage(reportData) {
  const reports = JSON.parse(localStorage.getItem('deepguard_reports') || '[]');
  reports.push({
    id: 'report_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
    timestamp: new Date().toISOString(),
    ...reportData
  });
  localStorage.setItem('deepguard_reports', JSON.stringify(reports));
}
</script>
{% endblock %}
